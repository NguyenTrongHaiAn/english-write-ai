// src/components/AuthPage.jsx

import React from 'react';
import './AuthPage.css'; // File CSS để trang trí
import axios from 'axios';
const API_URL = 'http://localhost:3001/api/auth';


function AuthPage() {
  // logic giao diện đăng nhập
  // sử dụng reak hooks useState để quan lý trạng thái nếu cần
  // có thể sử dụng useEffect để thực hiện các tác vụ khi component được mount
  const[isLoginMode, setIsLoginMode] = React.useState(true);  

  //state (trạng thái) là dữ liệu nội tại của một component, 
  // và có thể thay đổi theo thời gian 
  // (khi người dùng tương tác, hoặc khi dữ liệu bên ngoài thay đổi).

  //Hook (useState) dùng để tạo và quản lý state của một form gồm 3 trường: fullName, email, password.

  const [formData, setFormData] = React.useState({
    fullName: '',
    email: '',
    password: ''
  });
  const [message, setMessage] = React.useState('');
  const [isLoading, setIsLoading] = React.useState(false);
  //cách component lắng nghe sự kiện thay đổi của các trường input
  const handleChange=(e)=>{
    setFormData({
      //cú pháp "spread operator" trong JavaScript: ...
      // ...formData sao chép tất cả các trường hiện tại trong formData
      // và sau đó cập nhật trường cụ thể mà người dùng đang nhập.
      // Điều này giúp giữ nguyên các giá trị đã nhập trước đó.
      ...formData,
      //	Là name của input – dùng để xác định cập nhật trường nào
      //e.target.value là giá trị mới của trường input.
      //Cập nhật giá trị của trường tương ứng trong formData.
      [e.target.name]: e.target.value
    });
    // cách hoạt động như sau:
    //...formData	Tạo bản sao tất cả trường hiện tại trong form
    //[e.target.name]: e.target.value	Ghi đè đúng trường đang bị người dùng thay đổi
    //setFormData({...})	Gửi object mới này vào React để cập nhật và render lại form
        setMessage(''); // Xóa thông báo cũ khi người dùng bắt đầu gõ
  };

  //khi người dùng ấn vào register, sẽ thay đổi trạng thái isLoginMode
  const handleSwitchMode = (e) => {
    e.preventDefault(); 
    setIsLoginMode(!isLoginMode);
    setFormData({
      fullName: '',
      email: '',
      password: ''
    });
    setMessage(''); 
  };


  const handleSubmit = async (e) => {
      e.preventDefault(); // Ngăn form reload trang
      setIsLoading(true); // Bật trạng thái loading
      setMessage(''); // Xóa thông báo cũ

      const endpoint = isLoginMode ? '/login' : '/register';
      // Xác định endpoint dựa trên chế độ đăng nhập/đăng ký
      // API_URL là biến môi trường chứa URL của API
      const url=API_URL + endpoint;

      //payload là dữ liệu sẽ được gửi đến server khi người dùng đăng nhập hoặc đăng ký
      const payload = isLoginMode ? {
        email: formData.email,
        password: formData.password,
      } : {
        fullName: formData.fullName,
        email: formData.email,
        password: formData.password,
      };
      try {
        // Sử dụng axios để gửi request đến server
        // axios là thư viện giúp gửi HTTP requests
        // response là kết quả trả về từ server
        const response = await axios.post(url, payload);
        // Nếu đăng nhập/đăng ký thành công, lưu token và thông tin người dùng
        // response.data chứa dữ liệu trả về từ server
        setMessage(response.data.message ); // Hiển thị thông báo từ server
        //localStorage là nơi lưu trữ dữ liệu trên trình duyệt
        // setItem là phương thức để lưu dữ liệu vào localStorage 
        localStorage.setItem('token', response.data.token); // Lưu token vào localStorage
        localStorage.setItem('user', JSON.stringify(response.data.user)); // Lưu thông tin người dùng
        alert(response.data.message);
      }catch (error) { 
          if (error.response && error.response.data && error.response.data.message) {
            setMessage(error.response.data.message); // Hiển thị thông báo lỗi từ server
          }else {
            setMessage('Đã xảy ra lỗi, vui lòng thử lại sau.'); // Thông báo lỗi chung
          }console.error(error)
        } finally {
          setIsLoading(false); // Tắt trạng thái loading
        }
  };

  // xác thực người dùng đã đăng nhập và lấy thông tin cá nhân
  const fetchUserProfile = async () => {
  try {
    // 1. Lấy token đã được lưu từ localStorage
    const token = localStorage.getItem('token');

    if (!token) {
      alert("Bạn chưa đăng nhập!");
      return;
    }

    // 2. Tạo một "instance" của axios với cấu hình đặc biệt
    // để tự động đính kèm token vào mọi yêu cầu
    const api = axios.create({
      baseURL: 'http://localhost:3001/api/',
      headers: {
        // 3. Đính kèm token vào header 'Authorization'
        // Đây chính là lúc bạn "đeo thẻ nhân viên"
        'Authorization': `Bearer ${token}`
      }
    });

    // 4. Gửi yêu cầu đến một route được bảo vệ (chúng ta sẽ tạo route này ở backend)
    const response = await api.get('/users/profile'); // Ví dụ: GET /api/users/profile

    console.log("Thông tin cá nhân:", response.data);
    alert('Chào mừng trở lại, ${response.data.user.full_name}');


  } catch (error) {
    console.error("Không thể lấy thông tin cá nhân:", error);
    alert(error.response?.data?.message || "Phiên đăng nhập đã hết hạn hoặc không hợp lệ.");
  }
};
  return (
    <div className="auth-container">
      <div className="auth-form">
        <h2>HELLO!</h2>
        <p>Welcome to our platform. Please {isLoginMode ? 'log in' : 'register'} to continue.</p>
       
        <form onSubmit={handleSubmit}>

           {
            //short-circuit rendering : &&
          !isLoginMode && (
                <input
                  type="text"
                  name="fullName"
                  placeholder="Type your full name"
                  value={formData.fullName}
                  onChange={handleChange}
                  required
                />
               )
            }

          <input
            type="email"
            name="email"
            placeholder="Type your email"
            value={formData.email}
            onChange={handleChange}
            required
          />
          <input
            type="password"
            name="password"
            placeholder="Type your password"
            value={formData.password}
            onChange={handleChange}
            required
          />  
           {/* Hiển thị thông báo lỗi/thành công */}
          {message && <p style={{ color: 'red' }}>{message}</p>}
          
          <button type="submit">{isLoginMode ? 'Đăng nhập' : 'Đăng ký'}</button>
          

        </form>
       
        <div className="switch-auth">
            {isLoginMode ? "Don't have an account? " : "Already have an account? "}
          <a href="#" onClick={handleSwitchMode}>
            {isLoginMode ? 'Register' : 'Log In'}
          </a>
        </div>
      </div>
    </div>
  );
}

export default AuthPage;

